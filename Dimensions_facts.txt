----------------------------------------------CUSTOMER`_DIMENSION-------------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_CUSTDIM AS
    CURSOR GET_CUSTDIM IS (SELECT CUSTOMER_ID,CUSTOMER_NAME,CUSTOMER_PHONE,CUSTOMER_EMAIL,CUSTOMER_ADDRESS,CITY_NAME,STATE_NAME,COUNTRY_NAME
                            FROM COUNTRY_PRT C,STATE_PRT S,CITY_PRT C1,CUSTOMER_PRT C2
                            WHERE C.COUNTRY_ID=S.COUNTRY_ID
                            AND S.STATE_ID=C1.STATE_ID
                            AND C1.CITY_ID=C2.CITY_ID);
    VAR_COUNT NUMBER(5);
BEGIN
    FOR I IN GET_CUSTDIM LOOP
        SELECT COUNT(*) INTO VAR_COUNT
        FROM CUSTOMER_DIM_PR
        WHERE CUST_ID=I.CUSTOMER_ID  OR  CUST_NAME = I.CUSTOMER_NAME OR  CUST_PHONE = I.CUSTOMER_PHONE OR CUST_EMAIL = I.CUSTOMER_EMAIL;
            IF VAR_COUNT=0 THEN 
                INSERT INTO CUSTOMER_DIM_PR VALUES(SEQ_CUST_SUR.NEXTVAL,I.CUSTOMER_ID,I.CUSTOMER_NAME,
                                                I.CUSTOMER_PHONE,I.CUSTOMER_EMAIL,I.CUSTOMER_ADDRESS,
                                                I.CITY_NAME,I.STATE_NAME,I.COUNTRY_NAME,USER,SYSDATE);
            ELSE
                UPDATE CUSTOMER_DIM_PR SET CUST_PHONE = I.CUSTOMER_PHONE 
                WHERE CUST_ID = I.CUSTOMER_ID AND CUST_PHONE <> I.CUSTOMER_PHONE;
                UPDATE CUSTOMER_DIM_PR SET CUST_EMAIL = I.CUSTOMER_EMAIL
                WHERE  CUST_ID = I.CUSTOMER_ID AND  CUST_EMAIL <> I.CUSTOMER_EMAIL;
                UPDATE CUSTOMER_DIM_PR SET CUST_ADDRESS = I.CUSTOMER_ADDRESS
                WHERE  CUST_ID = I.CUSTOMER_ID AND  CUST_ADDRESS <> I.CUSTOMER_ADDRESS;
            END IF;
    END LOOP;
COMMIT;
END;



set serveroutput on;
exec SP_CUSTDIM;

SELECT * FROM CUSTOMER_DIM_PR;
SELECT * FROM CUSTOMER_PRT;


----------------------------------------PAYMNET METHOD DIMENSION------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_PAYMENTDIS AS
CURSOR GET_PAYMETHOD IS SELECT PAYMENT_METHOD_CODE,PAYMENT_METHOD_NAME,PAYMENT_METHOD_DESCRIPTION
                            FROM REF_PAYMENT_METHOD_PRT;
R_COUNT NUMBER(3);
BEGIN
 FOR I IN GET_PAYMETHOD LOOP
    SELECT COUNT(*) INTO R_COUNT
    FROM PAYMENT_METHODDIM_PR
    WHERE PAYMENT_METHOD_CODE = I.PAYMENT_METHOD_CODE;
        IF R_COUNT = 0 THEN
        INSERT INTO PAYMENT_METHODDIM_PR VALUES(SEQ_PAYMETHOD.NEXTVAL,I.PAYMENT_METHOD_CODE,I.PAYMENT_METHOD_NAME,I.PAYMENT_METHOD_DESCRIPTION,USER,SYSDATE);
        END IF;
END LOOP;
COMMIT;
END;


EXEC SP_PAYMENTDIS;

SELECT * FROM PAYMENT_METHODDIM_PR;


-------------------------------------------SHOP_DIMENSIONS-------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_SHOPDIM AS
CURSOR GET_SHOPDIM IS (SELECT SHOP_ID,SHOP_NAME,ADDRESS,OPEN_DATE,ZIP_CODE,CITY_NAME,STATE_NAME,COUNTRY_NAME
                        FROM SALES_OUTLET_PRT S,CITY_PRT C,STATE_PRT S1,COUNTRY_PRT C1
                        WHERE C1.COUNTRY_ID = S1.COUNTRY_ID AND S1.STATE_ID=C.STATE_ID AND C.CITY_ID = S.CITY_ID);
S_COUNT NUMBER(4);
BEGIN
FOR I IN GET_SHOPDIM LOOP
    SELECT COUNT(*) INTO S_COUNT
    FROM SHOP_DIM_PR
    WHERE SHOP_ID= I.SHOP_ID;
         IF S_COUNT = 0 THEN
         INSERT INTO SHOP_DIM_PR VALUES(SEQ_SHOPDIM.NEXTVAL,I.SHOP_ID,I.SHOP_NAME,I.ADDRESS,I.OPEN_DATE,I.ZIP_CODE,I.CITY_NAME,I.STATE_NAME,I.COUNTRY_NAME,USER,SYSDATE);
         END IF;
END LOOP;
COMMIT;
END;
         
EXEC SP_SHOPDIM;
         

--------------------------------------------EMPLOYEE _DIMENASIONS-------------------------------
CREATE OR REPLACE PROCEDURE SP_EMPDIM AS
CURSOR GET_EMPDIM IS (SELECT EMP_ID,EMP_NAME,EMP_PHONE,EMP_EMAIL,EMP_JOB,EMP_ADDRESS,EMP_MGR,EMP_CTC,EMP_HIREDATE,CITY_NAME,STATE_NAME,COUNTRY_NAME
                        FROM EMPLOYEE_PRT E,CITY_PRT C,STATE_PRT S1,COUNTRY_PRT C1
                        WHERE C1.COUNTRY_ID = S1.COUNTRY_ID AND S1.STATE_ID=C.STATE_ID AND C.CITY_ID = E.CITY_ID);
E_COUNT NUMBER(5);
BEGIN
FOR I IN GET_EMPDIM LOOP
    SELECT COUNT(*) INTO E_COUNT
    FROM EMP_DIM_PR
    WHERE EMP_ID = I.EMP_ID;
        IF E_COUNT = 0 THEN  ----WANT TO ADD MGRNAME----
            INSERT INTO EMP_DIM_PR VALUES(SEQ_EMPDIM.NEXTVAL,I.EMP_ID,I.EMP_NAME,I.EMP_PHONE,I.EMP_EMAIL,I.EMP_ADDRESS,I.EMP_JOB,I.EMP_MGR,I.EMP_HIREDATE,I.EMP_CTC,I.CITY_NAME,
            I.STATE_NAME,I.COUNTRY_NAME,USER,SYSDATE);
        END IF;
END LOOP;
COMMIT;
END;
            
          
EXEC SP_EMPDIM; 

SELECT * FROM EMP_DIM_PR;
SELECT * FROM EMPLOYEE_PRT;


-----------------------------------------PRODUCT_DIMENSION----------------------------------------
CREATE OR REPLACE PROCEDURE SP_PROD_DIM AS
   CURSOR CUR_PRODIM IS
       SELECT PRODUCT_ID,PRODUCT_NAME ,PRODUCT_FAMILY ,PRODUCT_WHOLESALE_PRICE,PRODUCT_RETAIL_PRICE,PRODUCT_LANCH_DATE,PRODUCT_EXPIRY_DATE,FROM_DATE,PROD_MANUFACTURE_NAME,PROD_MANUFACTURE_EMAIL,
       PROD_MANUFACTURE_PHONE,CITY_NAME,STATE_NAME,COUNTRY_NAME
       FROM PRODUCT_MANUFACTURE_PRT P1, PRODUCT_PRT P2, COUNTRY_PRT C1,STATE_PRT S1,CITY_PRT C2
       WHERE P1.PROD_MANUFACTURE_ID = P2.PROD_MANUFACTURE_ID
       AND C1.COUNTRY_ID=S1.COUNTRY_ID AND S1.STATE_ID = C2.STATE_ID AND C2.CITY_ID = P2.CITY_ID ;
   V_COUNT NUMBER(5);
BEGIN 
  FOR I IN CUR_PRODIM LOOP
    SELECT COUNT(*) INTO V_COUNT
    FROM PRODUCT_DIM_PR
    WHERE PROD_ID=I.PRODUCT_ID AND PROD_RETAIL_PRICE = I.PRODUCT_RETAIL_PRICE;
      If V_COUNT=0 THEN
        INSERT INTO PRODUCT_DIM_PR VALUES(SEQ_PRODUCTDIM.NEXTVAL,I.PRODUCT_ID,I.PRODUCT_NAME,I.PRODUCT_FAMILY,I.PRODUCT_WHOLESALE_PRICE,I.PRODUCT_RETAIL_PRICE,I.PRODUCT_LANCH_DATE,
        I.PRODUCT_EXPIRY_DATE,I.PROD_MANUFACTURE_NAME,I.PROD_MANUFACTURE_PHONE,I.PROD_MANUFACTURE_EMAIL,I.FROM_DATE,NULL,'Y',I.CITY_NAME,I.STATE_NAME,I.COUNTRY_NAME,SYSDATE,USER);
        UPDATE PRODUCT_DIM_PR SET TO_DATE=SYSDATE-1,CUR_REC_INDICATOR='N'
        WHERE PROD_ID=I.PRODUCT_ID AND PROD_RETAIL_PRICE != I.PRODUCT_RETAIL_PRICE;
    END IF;
  END LOOP;
  COMMIT;
END; 

EXEC SP_PROD_DIM;

SELECT * FROM PRODUCT_MANUFACTURE_PRT;
SELECT * FROM PRODUCT_PRT;
SELECT * FROM PRODUCT_DIM_PR;


-----------------------------------------CALENDER_DIMENSION-----------------------------------------
SELECT * FROM SALES_TXN_PRT;
SELECT * FROM CALENDER_DIM_PR;

CREATE OR REPLACE PROCEDURE SP_CALENDERDIMM AS
START_DATE DATE;
END_DATE DATE;
BEGIN
START_DATE := TRUNC(SYSDATE,'YY');
END_DATE := ADD_MONTHS(TRUNC(SYSDATE,'YY')-1,12);
WHILE START_DATE <= END_DATE LOOP
    INSERT INTO CALENDER_DIM_PR VALUES(SEQ_CALDIM.NEXTVAL,START_DATE,TO_CHAR(START_DATE,'DY'),TO_CHAR(START_DATE,'WW'),TO_CHAR(START_DATE,'MON'),TO_CHAR(START_DATE,'MM'),
    TO_CHAR(START_DATE,'YYYY'),TO_CHAR(START_DATE,'Q'),USER,SYSDATE);
START_DATE := START_DATE + 1;
END LOOP;
COMMIT;
END;   
    
    
    
EXEC SP_CALENDERDIMM;
SET SERVEROUTPUT ON ;



---------------------------------------SALES_FACTS------------------------------------------------------------------
CREATE OR REPLACE PROCEDURE SP_SALES_TXN_FACT AS
CURSOR C_SALES_TXN_FACT IS
SELECT P3.TRANSACTION_ID,CUST_SUR_ID,S1.SHOP_SUR_ID,P1.PROD_SUR_ID,E1.EMP_SUR_ID,QUANTITY,PROD_WHOLESALE_PRICE,PROD_RETAIL_PRICE
FROM CUSTOMER_DIM_PR C1, PRODUCT_DIM_PR P1, EMP_DIM_PR E1 , SHOP_DIM_PR S1, PAYMENT_METHODDIM_PR P2, 
            CALENDER_DIM_PR C2, SALES_TXN_PRT S2, PRODUCT_IN_TXN_PRT P3 
WHERE S2.TRANSACTION_ID = P3.TRANSACTION_ID AND
            S2.PRODUCT_ID=P1.PROD_ID AND
            S2.SHOP_ID=S1.SHOP_ID AND
            S2.EMP_ID=E1.EMP_ID AND
            S2.PRODUCT_ID = P1.PROD_ID AND
            S2.TRANSACTION_DATE = C2.CAL_DATE ;           
V_SALES_COUNT NUMBER(5);
BEGIN
FOR I IN C_SALES_TXN_FACT LOOP
        SELECT COUNT(*) INTO V_SALES_COUNT
        FROM SALES_FACT_PR 
        WHERE  SOURCE_TRANSACTION_ID = I.TRANSACTION_ID AND CUST_SUR_ID=I.CUST_SUR_ID AND SHOP_SUR_ID=I.SHOP_SUR_ID AND 
                    PROD_SUR_ID=I.PROD_SUR_ID AND EMP_SUR_ID=I.EMP_SUR_ID AND QTY=I.QUANTITY AND WHOLE_SALE_PRICE=I.PROD_WHOLESALE_PRICE
                    AND RETAIL_PRICE=I.PROD_RETAIL_PRICE ;
        IF V_SALES_COUNT = 0 THEN
        INSERT INTO SALES_FACT_PR VALUES(SEQ_FACT_ID.NEXTVAL, I.TRANSACTION_ID, I.CUST_SUR_ID, I.SHOP_SUR_ID, I.PROD_SUR_ID, I.EMP_SUR_ID, I.QUANTITY,
                                                                            I.PROD_WHOLESALE_PRICE, I.PROD_RETAIL_PRICE, I.PROD_RETAIL_PRICE*I.QUANTITY);
      
        END IF;
END LOOP;
END;
    
    
EXEC    SP_SALES_TXN_FACT;
    
    
