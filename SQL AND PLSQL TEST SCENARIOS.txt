SELECT * FROM CUST_TRANSACTION;
SELECT * FROM ACCOUNTSS;
SELECT * FROM TRANSACTION;

--1)TO DISPLAY CUSTOMERS WHO ARE FROM BANGALORE AND HAVE OPENED SAVINGS ACCOUNT ON THEIR BIRTHDAY---
SELECT CUST_NAME FROM 
CUST_TRANSACTION
WHERE CITY='BANGALORE' and cust_bkey in (select A.CUST_BKEY 
                                        FROM ACCOUNTSS A ,CUST_TRANSACTION C
                                        WHERE C.CUST_BKEY=A.CUST_BKEY
                                        AND ACT_TYPE='SAVINGS'
                                        AND TO_CHAR(ACT_OPEN_DATE,'DD-MM') =TO_CHAR(DOB,'DD-MM'));

UPDATE CUST_TRANSACTION  SET DOB='12-05-22' WHERE CUST_BKEY=202;
UPDATE CUST_TRANSACTION SET CITY='BANGALORE' WHERE CUST_BKEY=202;
COMMIT;
SELECT * FROM CUST_TRANSACTION;

--2)TO PRINT FACTORIA OF A NUMBER--
DECLARE 
NUM NUMBER (10);
F_FACT NUMBER(10);
BEGIN
NUM := 5;
F_FACT :=1;
FOR I IN 1..NUM LOOP
F_FACT := F_FACT * I;
END LOOP;
DBMS_OUTPUT.PUT_LINE(F_FACT);
END;

SET SERVEROUTPUT ON

SELECT TO_CHAR(SYSDATE,'W') FROM DUAL;

--3)TO DISPLAY CUSTOMERS WHO DID 5 TRANSACTIONS IN THE CURRENT WEEK
SELECT CUST_NAME   
FROM ACCOUNTSS A, TRANSACTION T,CUST_TRANSACTION C
        WHERE A.A_NO =T.A_NO
        AND C.CUST_BKEY=A.CUST_BKEY
        AND TO_CHAR(TXN_DATE,'W-YY')=TO_CHAR(SYSDATE,'W-YY')
        GROUP BY T.A_NO,CUST_NAME
        HAVING COUNT(TXN_ID)=1;
        

UPDATE TRANSACTION SET TXN_DATE='12-05-2022' WHERE TXN_ID=654;
SELECT *FROM TRANSACTION;
COMMIT;


--4)TO DISPLAY ACCOUNTS WHICH ARE OF LOAN TYPE AND HAS BEEN OPENED IN THE 3RD QUARTER OF PREVIOUS YAER--
SELECT A_NO 
FROM ACCOUNTSS
WHERE ACT_TYPE='LOAN' AND 
TO_CHAR(ACT_OPEN_DATE,'Q')=3 AND 
TO_CHAR(ACT_OPEN_DATE,'YYYY')=TO_CHAR(SYSDATE,'YYYY')-1;

SELECT TO_CHAR(SYSDATE,'Q') FROM DUAL;
UPDATE ACCOUNTSS SET CUST_BKEY=203  WHERE A_NO=354 ;
UPDATE ACCOUNTSS SET ACT_TYPE='LOAN' WHERE A_NO=3238;
COMMIT;
SELECT * FROM ACCOUNTSS;

--5)TO DISPLAY CUSTOMERS WHO HAVE OPNED MAXIMUM NUMBER OF ACCOUNTS IN THE CURRENT MONTH--
UPDATE ACCOUNTSS SET ACT_OPEN_DATE='1-08-2021' WHERE A_NO =3238;
COMMIT;

SELECT CUST_NAME
        FROM CUST_TRANSACTION C,ACCOUNTSS A
        WHERE C.CUST_BKEY=A.CUST_BKEY
        AND TO_CHAR(ACT_OPEN_DATE,'MM-YYYY')=TO_CHAR(SYSDATE,'MM-YYYY')
        GROUP BY CUST_NAME
        HAVING COUNT(A_NO)=(SELECT MAX(COUNT(A_NO))
                            FROM ACCOUNTSS
                            WHERE TO_CHAR(ACT_OPEN_DATE,'MM-YYYY')=TO_CHAR(SYSDATE,'MM-YYYY')
                            GROUP BY CUST_BKEY);
                            

--6)TO DISPLAY CUSTOMERS HAVING ATLEAST5 ACCOUNTS OF THE SAME TYPE--
SELECT CUST_NAME
FROM (SELECT COUNT(A_NO),A.CUST_BKEY,ACT_TYPE
        FROM ACCOUNTSS A, CUST_TRANSACTION C
        WHERE A.CUST_BKEY=C.CUST_BKEY
        GROUP BY ACT_TYPE,A.CUST_BKEY
        HAVING COUNT(A_NO)>1)A,CUST_TRANSACTION C
        WHERE A.CUST_BKEY=C.CUST_BKEY;
        
SELECT * FROM ACCOUNTSS;


--7)TO DISPLAY CUSTOMERS WHO DID 3TRANSACTION IN THE CURRENT MONTH AND PREVIOUS MONTH--
SELECT CUST_NAME
FROM (SELECT COUNT(TXN_ID),A.A_NO,A.CUST_BKEY
        FROM CUST_TRANSACTION C,ACCOUNTSS A,TRANSACTION T
        WHERE A.CUST_BKEY=C.CUST_BKEY AND 
        A.A_NO=T.A_NO
        AND TO_CHAR(TXN_DATE,'MM')=TO_CHAR(SYSDATE,'MM')
        GROUP BY A.A_NO,A.CUST_BKEY
        HAVING COUNT(TXN_ID)=1)A,CUST_TRANSACTION C
        WHERE A.CUST_BKEY=C.CUST_BKEY
INTERSECT
SELECT CUST_NAME
FROM (SELECT COUNT(TXN_ID),A.A_NO,A.CUST_BKEY
        FROM CUST_TRANSACTION C,ACCOUNTSS A,TRANSACTION T
        WHERE A.CUST_BKEY=C.CUST_BKEY AND A.A_NO=T.A_NO
        AND TO_CHAR(TXN_DATE,'MM')=TO_CHAR(SYSDATE,'MM')-1
        GROUP BY A.A_NO,A.CUST_BKEY
        HAVING COUNT(TXN_ID)=1)A,CUST_TRANSACTION C
        WHERE A.CUST_BKEY=C.CUST_BKEY;
COMMIT;

SELECT TO_CHAR(SYSDATE,'MM')-1 FROM DUAL;
SELECT * FROM TRANSACTION;

8)TO DISPLAY YEARWISE NUMBER OF CUSTOMERS WHO HAVE OPENED SAVINGS ACCOUNT FROM PAST 3MONTHS--
SELECT TO_CHAR(ACT_OPEN_DATE,'YY'),COUNT(CUST_BKEY)
FROM ACCOUNTSS
WHERE ACT_TYPE='SAVINGS' AND 
TO_CHAR(ACT_OPEN_DATE,'MM')>= TO_CHAR(SYSDATE,'MM')-3
GROUP BY TO_CHAR(ACT_OPEN_DATE,'YY');

SELECT * FROM ACCOUNTSS;
UPDATE ACCOUNTSS SET ACT_TYPE='SAVINGS' WHERE A_NO=3578;


--9) WRITE A PROGRAM WHICH TAKES CUSTOMERS NAME AS INPUT AND RETURNS TOTAL TRANSACTIONS AMOUNT IN THE 
        CURRENT WEEK---
CREATE OR REPLACE PROCEDURE EMP_TBL AS
CURSOR GET_D IS (SELECT CUST_NAME,C.CUST_BKEY,A.A_NO,T.TXN_ID,FCY_AMT,TXN_DATE
                FROM CUST_TRANSACTION C,ACCOUNTSS A,TRANSACTION T
                WHERE A.CUST_BKEY=C.CUST_BKEY AND A.A_NO=T.A_NO);
N_SUM NUMBER;
E_CHAR VARCHAR2(20);
BEGIN
E_CHAR := 'MONI';
FOR I IN GET_D LOOP
SELECT SUM(FCY_AMT) INTO N_SUM
FROM CUST_TRANSACTION C,ACCOUNTSS A,TRANSACTION T
WHERE C.CUST_BKEY=A.CUST_BKEY AND T.A_NO=A.A_NO AND TO_CHAR(TXN_DATE,'W-YYYY')=TO_CHAR(SYSDATE,'W-YYYY')
AND CUST_NAME=E_CHAR;
END LOOP;
DBMS_OUTPUT.PUT_LINE(N_SUM);
END;

SET SERVEROUTPUT ON
EXEC EMP_TBL;
SELECT * FROM TRANSACTION;